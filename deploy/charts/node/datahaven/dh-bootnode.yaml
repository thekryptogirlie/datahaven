name: dh-bootnode
description: Datahaven Bootnode
fullnameOverride: dh-bootnode

image:
  repository: moonsonglabs/datahaven
  tag: main
  pullPolicy: Always

imagePullSecrets:
  - name: datahaven-dockerhub

node:
  command: datahaven-node
  customChainspec: true # see extraInitContainers, chainspec-generator
  role: full
  replicas: 1
  chainData:
    pruning: 1000
    storageClass: "gp2"
  chainKeystore:
    mountInMemory:
      enabled: true
  persistGeneratedNodeKey: true
  flags:
    - "--allow-private-ipv4"
    - "--discover-local"
    - "--network-backend libp2p"

ingress:
  enabled: false
  perReplica: false
  wildcardDomain: datahaven.local
  # If enabled, this would generate:
  # - dh-bootnode-0.datahaven.local

# Generate chainspec, and expose it as url
extraInitContainers:
  - name: chainspec-generator
    image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
    securityContext:
      runAsUser: 0
    command: ["/bin/bash"]
    args:
      - -c
      - |
        apt update || true
        apt install -y jq
        
        # Wait for node key to be generated by the persist-generated-node-key init container
        echo "Waiting for node key generation..."
        for i in {1..60}; do
          [ -f /keystore/node-key ] && break
          echo "Node key not found, waiting ($i/60)â€¦"
          sleep 2
        done
        [ -f /keystore/node-key ] || { echo "Node key generation timed out"; exit 1; }

        # Extract the peer ID from the generated node key
        NODE_PEER_ID="$({{ .Values.node.command }} key inspect-node-key --file /keystore/node-key)"
        echo "Using generated peer ID: ${NODE_PEER_ID}"
        
        # Generate chainspec with dynamic peer ID
        {{ .Values.node.command }} build-spec --chain {{ .Values.node.chain }} > base.json
        echo "{\"bootNodes\":[\"/dns/dh-bootnode-0/tcp/30333/p2p/${NODE_PEER_ID}\"]}" > override1.json
        jq  -s '.[0] * .[1]' base.json override1.json | sed 's/1e+18/1000000000000000000/' > plain.json
        cut -c -256 plain.json
        {{ .Values.node.command }} build-spec --chain plain.json --raw  > chainspec.json
        cp chainspec.json {{ .Values.node.customChainspecPath }}
    volumeMounts:
      - mountPath: /chain-data
        name: chain-data
      - mountPath: /keystore
        name: chain-keystore
extraContainers:
  - name: chainspec
    image: nginxinc/nginx-unprivileged:stable
    ports:
      - containerPort: 8080
        name: web
    volumeMounts:
      - name: chain-data
        subPath: chainspec.json
        mountPath: /usr/share/nginx/html/chainspec.json
        readOnly: true 